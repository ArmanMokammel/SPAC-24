{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap");
    </style>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        font-family: "Roboto", serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(93deg, #87c4ff, #00498d);
        /* background: white; */
        height: 100vh;
      }

      /* Navbar */
      .navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #f8f8f8;
        color: #000;
        /* font-weight: bold; */
        padding: 10px 20px;
        font-size: 1.5rem;
      }

      .navbar img {
        width: 200px;
        height: 50px;
        object-fit: cover;
      }

      .navbar .logout {
        background-color: #ff3333;
        color: white;
        border: none;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1rem;
        text-decoration: none;
      }

      /* Buttons */
      .button-group {
        display: flex;
        gap: 6px;
        padding: 20px;
        flex-wrap: wrap;
      }

      .button-group button {
        padding: 8px 20px;
        border: 1px solid #ffffff;
        background: transparent;
        cursor: pointer;
        border-radius: 5px;
        /* font-weight: bold; */
        color: #f8f8f8;
      }

      /* Smooth Transition x  xs */
      .status-x xs {
        display: none;
        /* background-color: white; */
        padding: 0 20px 20px;
        /* border: 1px solid #ccc; */
        /* box-shadow: 2px 2px 2px 2px #ddd; */
        /* margin: 20px; */
        justify-content: space-between;
        align-items: flex-start;
        /* border-radius: 4px; */
      }

      .close-status {
        display: none;
        position: relative;
        top: -12px;
        right: 22px;
        background-color: #ff3333;
        border-radius: 50%;
        color: white;
        border: 1px solid #ff3333;
        cursor: pointer;
        border-radius: 4px;
      }

      /* Modal Overlay */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal {
        position: relative;
        background-color: #f8f8f8;
        padding: 16px 12px;
        border-radius: 5px;
        max-width: 225px;
        margin: auto;
        top: 20%;
      }

      .modal .radio-group {
        margin-bottom: 14px;
        line-height: 1.7;
      }

      .modal button {
        padding: 10px 20px;
        background-color: lightblue;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }

      /* Search and Filter */
      .search-filter {
        display: flex;
        gap: 10px;
        padding: 0 20px 0;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .search-filter > input {
        /* min-width: 200px; */
        border: 1px solid #ddd;
        /* box-shadow: 2px 2px 1px 1px #ddd; */
        border-radius: 4px;
        height: 30px;
        width: 250px;
        padding: 0 14px;
      }

      .filter-options {
        display: none;
        background-color: #f8f8f8;
        padding: 10px;
        border: 1px solid #272727;
        box-shadow: 2px 2px 1px 1px #f8f8f8;
        position: absolute;
        /* left: 20px; */
        /* bottom: 20px; */
        border-radius: 4px;
        max-width: 300px;
        max-height: 100px;
        overflow-x: auto;
        z-index: 100;
        cursor: pointer;
        margin-left: 388px;
      }

      #filter {
        text-decoration: none;
        border: none;
        border-radius: 4px;
        padding: 8px 30px;
        background: #3949ab;
        color: white;
        cursor: pointer;
      }
      .filter-options > label {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      /* Table */

      table,
      th,
      td {
        border-bottom: 1px solid #272727;
        z-index: -1;
        position: relative;
      }

      th,
      td {
        padding: 10px 14px;
        text-align: center;
      }

      th {
        color: #272727;
        background-color: #f8f8f8;
        height: 35px;
      }
      table {
        width: fit-content;
        border-collapse: collapse;
        background-color: #f8f8f8;
        border-radius: 4px;
        border: 1px solid #f8f8f8;
        max-height: 58vh;
        display: x  x;
        margin: 20px;
        overflow: auto;
      }
      .button-group-outerdiv {
        display: flex;
        justify-content: space-between;
      }
      .footer {
        background-color: #f8f8f8;
        /* color: white; */
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        padding: 10px 0;
        z-index: -1;
      }
      .footer img {
        height: 68px;
      }
      .count {
        font-size: 1.5rem;
        color: #000;
      }
      .box {
        width: 301px;
        border-radius: 4px;
        box-shadow: 2px 2px 1px 1px #e4e4e4;
        padding: 8px;
        background-color: #f8f8f8;
      }
      video{
        width: 100%;
      }
      /* Responsive Design */
      @media (max-width: 768px) {
        .navbar {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .button-group {
          /* flex-direction: column; */
          align-items: stretch;
          justify-content: center;
        }

        .search-filter {
          flex-direction: column;
          margin-bottom: 12px;
        }

        table {
          font-size: 14px;
          margin: 0;
          margin: 0 6%;
        }

        th,
        td {
          padding: 5px;
        }
      }

      @media (max-width: 480px) {
        .navbar {
          font-size: 14px;
          align-items: center;
        }

        .button-group-outerdiv {
          justify-content: center;
        }
        .button-group button {
          font-size: 14px;
          padding: 10px;
        }

        .modal {
          width: 100%;
          max-width: none;
          padding: 15px;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 5px;
        }
        .footer img {
          height: 27px;
        }
        .count {
          font-size: 1rem;
        }
        .box {
          width: 100%;
        }
      }
      .container {
        max-width: 1048px;
        margin: auto;
      }
      th {
        position: sticky;
        z-index: -1;
        top: 0;
      }
      .stat_name {
        color: rgb(64, 64, 64);
      }
      .stats {
        display: flex;
        flex-direction: row;
        gap: 16px;
        margin-top: 16px;
        flex-wrap: wrap;
      }
      #cancel-session {
        background-color: #ff3333;
        color: white;
      }
      input[type="checkbox"] {
        height: 20px;
        width: 20px;
      }
      table::-webkit-scrollbar {
        width: 6px; /* Width of the scrollbar */
      }

      table::-webkit-scrollbar-track {
        background: #f1f1f1; /* Background of the track */
      }

      table::-webkit-scrollbar-thumb {
        background: #c5c5c5; /* Color of the thumb */
        border-radius: 6px; /* Rounded corners for the thumb */
      }

      table::-webkit-scrollbar-thumb:hover {
        background: #555; /* Color on hover */
      }
      .filter-options::-webkit-scrollbar {
        width: 12px; /* Width of the scrollbar */
      }

      .filter-options::-webkit-scrollbar-track {
        background: #f1f1f1; /* Background of the track */
      }

      .filter-options::-webkit-scrollbar-thumb {
        background: #c5c5c5; /* Color of the thumb */
        border-radius: 6px; /* Rounded corners for the thumb */
      }

      .filter-options::-webkit-scrollbar-thumb:hover {
        background: #555; /* Color on hover */
      }
      #tap-to-scan {
        background-color: #f8f8f8;
        color: #00498d;
        border: 1px solid #00498d;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <div class="navbar">
      <img src="{% static '/img/SPAC.png' %}" alt="logo" />
      <div>Current Session: {% for session in token_sessions %}{{session.session_name}}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
      <a href="#" class="logout">Logout</a>
    </div>

    <div class="container">
      <!-- Button Group -->
      <div class="button-group-outerdiv">
        <div class="button-group">
          <button id="view-status">View Status</button>
          <button id="set-session">Set Session</button>
          <button id="tap-to-scan">Tap to Scan</button>
        </div>
      </div>


    <!-- Status x xs -->
    <div class="status-blocks" id="status-blocks">
      <div class="stats">
        <div class="box">
          <div class="stat_name">Registered:</div>
          <div class="count">{{total_participants}}</div>
        </div>
        {% for session in token_sessions_with_participant_count %}
        <div class="box">
            <div class="stat_name">{{session.session_name}}:</div>
            <div class="count">{{session.participant_count}}</div>
        </div> 
        {% endfor %}
        <button class="close-status" id="close-status">X</button>
      </div>
    </div>
<!-- Modal -->
<div id="modal-sessions" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);">
  <div style="margin: 5% auto; background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
    <h2 style="font-size: 1.5em; text-align: center;">Select a Session</h2>
    <ul id="session-urls" style="list-style: none; padding: 0; margin: 20px 0; text-align: center;">
      <!-- Session links will be dynamically added here -->
    </ul>
    <button id="close-modal" style="display: block; margin: 0 auto; padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
  </div>
</div>
<div>
<!-- QR Code Reader -->
<div id="reader" style="display: none;
width: 300px;
height: 300px;
margin: 20px auto;
text-align: center;
position: absolute;
top: 150px;
background: #f8f8f8;
padding: 8px;
border-radius: 4px;
border: 1px solid;">
  <div id="reader-container" style="position: relative;">
    <div id="reader" style="width: 100%; height: 300px;"></div>
    <button id="stop-scan" style="margin-top: 10px; padding: 10px 20px; background: #FF0000; color: white; border: none; border-radius: 5px; cursor: pointer;">Stop Scanning</button>
  </div>
</div>
</div>

      <!-- Modal -->
      <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="set-session-modal">
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="session1"
              name="session"
              value="Breakfast"
            />
            <label for="session1">Breakfast</label><br />
            <input type="checkbox" id="session2" name="session" value="Lunch" />
            <label for="session2">Lunch</label><br />
            <input
              type="checkbox"
              id="session3"
              name="session"
              value="Dinner"
            />
            <label for="session3">Dinner</label><br />
            <input
              type="checkbox"
              id="session4"
              name="session"
              value="Goodies"
            />
            <label for="session4">Goodies</label>
          </div>
          <div
            style="
              display: flex;
              align-items: flex-end;
              display: flex;
              justify-content: center;
              gap: 4px;
            "
          >
            <button id="select-session">Select Session</button>
            <button id="cancel-session">Cancel</button>
          </div>
        </div>
      </div>

    <!-- Search and Filter -->
    <div class="search-filter">
      <input type="text" id="search" placeholder="Search..." />
      <button id="filter">Filter</button>
      <div class="filter-options" id="filter-options">
        {% for participant_university in participant_universities %}
        <label
          ><input type="checkbox" value="{{participant_university.university}}" /> {{participant_university.university}}</label
        ><br/>
        {% endfor %}
      </div>
    </div>

    <!-- Table -->
     <div style="display: flex; justify-content: center;">
    <table>
        <thead>
          <tr>
            <th>SL</th>
            <th>Name</th>
            <th>University</th>
            <th>Tshirt Size</th>
            <th>Role</th>
            <th>Contact</th>
            {% for session in token_sessions_all %}
            <th>{{session.session_name}}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for participant in registered_participants %}
          <tr>
            <td>{{participant.id}}</td>
            <td>{{participant.name}}</td>
            <td>{{participant.university}}</td>
            <td>{{participant.t_shirt_size}}</td>
            <td>{{participant.role}}</td>
            <td>{{participant.contact_no}}</td>
            {% for session in token_sessions_all %}
            <td><input type="checkbox" {% for token in participant.tokens %}{% if token.token_session.id == session.id %}checked{% endif %}{% endfor %} /></td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>

    <div class="footer">
        <img src="{% static '/img/Logos-For-DOC-1.png' %}" alt="logo">
    </div>
    <script>
      // View Status Button
      const viewStatusBtn = document.getElementById("view-status");
      const statusBlocks = document.getElementById("status-blocks");
      const closeStatusBtn = document.getElementById("close-status");

      viewStatusBtn.addEventListener("click", () => {
        statusBlocks.style.display = "flex";
        viewStatusBtn.style.display = "none";
        closeStatusBtn.style.display = "block";
      });

      closeStatusBtn.addEventListener("click", () => {
        statusBlocks.style.display = "none";
        viewStatusBtn.style.display = "inline-block";
        closeStatusBtn.style.display = "none";
      });

      const setSessionBtn = document.getElementById("set-session");
      const setSessionModal = document.getElementById("set-session-modal");
      const selectSessionBtn = document.getElementById("select-session");
      const cancelSessionBtn = document.getElementById("cancel-session");
      const modalOverlay = document.getElementById("modal-overlay");
      const navbarSessionText = document.querySelector(".navbar > div");

      // Open the modal
      setSessionBtn.addEventListener("click", () => {
        modalOverlay.style.display = "block";
      });

      // Close the modal on "Select Session"
      selectSessionBtn.addEventListener("click", () => {
        const selectedSessions = Array.from(
          document.querySelectorAll('input[name="session"]:checked')
        ).map((checkbox) => checkbox.value);

        if (selectedSessions.length > 0) {
          navbarSessionText.textContent = `Current Sessions: ${selectedSessions.join(
            ", "
          )}`;
        } else {
          navbarSessionText.textContent = "No session selected";
        }

        modalOverlay.style.display = "none";
      });

      // Close the modal on "Cancel"
      cancelSessionBtn.addEventListener("click", () => {
        modalOverlay.style.display = "none";
      });

      // Close the modal when clicking outside of it
      modalOverlay.addEventListener("click", (event) => {
        if (event.target === modalOverlay) {
          modalOverlay.style.display = "none";
        }
      });

      // Tap to Scan Button
// JavaScript
const serverURL = '{% url "core:process_qr_data" %}';
const tapToScanBtn = document.getElementById("tap-to-scan");
const qrReaderElement = document.getElementById("reader");
const modalSessions = document.getElementById("modal-sessions");
const sessionUrls = document.getElementById("session-urls");
const closeModalBtn = document.getElementById("close-modal");
const stopScanBtn = document.getElementById("stop-scan");

let html5QrCode; // Global variable to manage QR scanning

// Example session URLs
const sessions = [
  { id: 1, url: "https://example.com/session1" },
  { id: 2, url: "https://example.com/session2" },
];

// Populate the modal with session URLs
const populateModal = () => {
  sessionUrls.innerHTML = ""; // Clear previous content
  sessions.forEach((session) => {
    const li = document.createElement("li");
    li.style.marginBottom = "10px";
    li.innerHTML = `<a href="#" data-id="${session.id}" data-url="${session.url}" style="color: #007BFF; text-decoration: none; font-size: 1.2em;">${session.url}</a>`;
    sessionUrls.appendChild(li);
  });
};

// Open modal with sessions
tapToScanBtn.addEventListener("click", () => {
  modalSessions.style.display = "block";
  populateModal();
});

// Close modal
closeModalBtn.addEventListener("click", () => {
  modalSessions.style.display = "none";
});

// Handle URL click to start QR scanning
sessionUrls.addEventListener("click", (event) => {
  if (event.target.tagName === "A") {
    event.preventDefault();
    const sessionId = event.target.getAttribute("data-id");
    const sessionUrl = event.target.getAttribute("data-url");
    modalSessions.style.display = "none"; // Close the modal
    qrReaderElement.style.display = "x  x"; // Show QR reader

    // Initialize QR reader
    html5QrCode = new Html5Qrcode("reader");
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
      alert(`Decoded: ${decodedText}`);

      fetch(serverURL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "session-id": sessionId },
        body: JSON.stringify({ url: sessionUrl, data: decodedText }),
      })
        .then((response) => response.json())
        .then((data) => console.log("Server Response:", data))
        .catch((err) => console.error("Error:", err));

      html5QrCode.stop().catch((err) => console.error("Failed to stop:", err));
    };

    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      videoConstraints: {
        facingMode: "environment", // Use back camera
      },
    };

    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
  }
});

// Stop scanning
stopScanBtn.addEventListener("click", () => {
  if (html5QrCode) {
    html5QrCode.stop()
      .then(() => {
        qrReaderElement.style.display = "none"; // Hide QR reader
        console.log("Scanning stopped");
      })
      .catch((err) => console.error("Failed to stop scanning:", err));
  }
});


// Stop scanning
stopScanBtn.addEventListener("click", () => {
  if (html5QrCode) {
    html5QrCode.stop()
      .then(() => {
        qrReaderElement.style.display = "none"; // Hide QR reader
        console.log("Scanning stopped");
      })
      .catch((err) => console.error("Failed to stop scanning:", err));
  }
});




      // Filter Dropdown
      const filterBtn = document.getElementById("filter");
      const filterOptions = document.getElementById("filter-options");
      const searchInput = document.getElementById("search");
      const tableRows = document.querySelectorAll("table tbody tr");

      filterBtn.addEventListener("click", () => {
        filterOptions.style.display =
          filterOptions.style.display === "x  x" ? "none" : "x x";
      });

      filterOptions.addEventListener("change", () => {
        const selectedUniversities = Array.from(
          filterOptions.querySelectorAll("input:checked")
        ).map((checkbox) => checkbox.value.toLowerCase());
        filterTable(selectedUniversities, searchInput.value.toLowerCase());
      });

      searchInput.addEventListener("input", function () {
        const filter = searchInput.value.toLowerCase();

        tableRows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const name = cells[1].textContent.toLowerCase();
          const university = cells[2].textContent.toLowerCase();
          const contact = cells[3].textContent.toLowerCase();
          const ieeeId = cells[5].textContent.toLowerCase();

          // Check if any column matches the search input
          if (
            name.includes(filter) ||
            university.includes(filter) ||
            contact.includes(filter) ||
            ieeeId.includes(filter)
          ) {
            row.style.display = ""; // Show the row
          } else {
            row.style.display = "none"; // Hide the row
          }
        });
      });

      function filterTable(universities, searchTerm) {
        tableRows.forEach((row) => {
          const nameCell = row.cells[1].textContent.toLowerCase();
          const universityCell = row.cells[2].textContent.toLowerCase();
          const matchesUniversity = universities.length
            ? universities.includes(universityCell)
            : true;
          const matchesSearch = nameCell.includes(searchTerm);
          row.style.display = matchesUniversity && matchesSearch ? "" : "none";
        });
      }
      const checkboxes = document.querySelectorAll(
        'table input[type="checkbox"]'
      );
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            Swal.fire({
              title: "Are you sure?",
              // text: "You won't be able to revert this!",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "Yes!",
            }).then((result) => {
              if (result.isConfirmed) {
                Swal.fire({
                  title: "Success!",
                  // text: "Your file has been deleted.",
                  icon: "success",
                });
              }
              else{
                checkbox.checked = false;
              }
            });
          }
        });
      });
    </script>
  </body>
</html>
